<!DOCTYPE HTML>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<title>å¤©ç·šå¯¶å¯¶è¨å‚µé›†åœ˜</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<link rel="stylesheet" href="assets/css/main.css" />
<style>
:root{ --radius:12px; --gap:14px; }
body{ font-family:"Noto Sans TC",sans-serif; background:#fafafa; margin:0; }
.wrap{max-width:980px;margin:0 auto;padding:18px;}
.card{background:#fff;border:1px solid #eaeaea;border-radius:var(--radius);padding:14px;box-shadow:0 2px 16px rgba(0,0,0,.04);margin-bottom:14px;}
.toolbar{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid #eee;}
.toolbar .inner2{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 18px;}
.toolbar-left{display:flex;align-items:center;gap:10px;}
.toolbar-left b{font-weight:700;color:#555;}
.toolbar-left select{height:36px;padding:0 12px;border-radius:10px;border:1px solid #e6e6e6;background:#f7f7f7;font-weight:600;font-size:15px;}
.badge-group{display:flex;align-items:center;gap:12px 14px;}
.badge{display:flex;align-items:center;gap:6px;white-space:nowrap;}
.pill{display:inline-flex;align-items:center;height:36px;padding:0 14px;border-radius:10px;border:1px solid #e6e6e6;background:#f7f7f7;font-weight:600;}
.pill.ok{background:#e9f7ef;border-color:#d4efdf}
.pill.warn{background:#fff6e6;border-color:#ffe0a3}
.hidden{display:none;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
form label{display:block;margin:.25rem 0 .35rem}
input,select,button{width:100%;padding:14px;border:1px solid #ddd;border-radius:10px;background:#fff;font-size:16px}
button.primary{background:#111;color:#fff;border-color:#111;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border-bottom:1px solid #eee;padding:8px;text-align:left;}
td.right{text-align:right;}
input[readonly]{background:#f3f3f3;cursor:not-allowed;}

#payerSelect,
#debtorSelect,
#splitSelect {
  height: 48px;
  font-size: 16px;
  padding: 10px 14px;
  line-height: 1.4;
}

</style>
</head>
<body class="is-preload">

<!-- Headerï¼ˆä¿ç•™å¦³çš„ templateï¼‰ -->
<header id="header">
  <div class="inner">
    <h1><strong>CHIAYU's WEBSITE</strong></h1>
    <h1>An Engineer.</h1>
  </div>
</header>

<!-- Toolbar é¡¯ç¤ºäººç‰©èˆ‡é‡‘é¡ç‹€æ…‹ -->
<div class="toolbar">
  <div class="inner2">
    <div class="toolbar-left">
      <b>å¤©ç·šå¯¶å¯¶è¨å‚µé›†åœ˜</b>
      <select id="userSelect">
        <option value="ä¸ä¸" selected>ä¸ä¸</option>
        <option value="è¿ªè¥¿">è¿ªè¥¿</option>
        <option value="å°æ³¢">å°æ³¢</option>
      </select>
    </div>
    <div class="badge-group">
      <div class="badge">é‡‘é¡ <span id="overallValue" class="pill warn">$0.00</span></div>
      <div class="badge">èº«ä»½ <span id="statusValue" class="pill warn">â€”</span></div>
    </div>
  </div>
</div>

<div id="main" class="wrap">
  <!-- æ–°å¢ä¸€ç­†ï¼šç¨ç«‹å¡ç‰‡ -->
  <div class="card">
    <h3 style="margin:0 0 10px 0">æ–°å¢ä¸€ç­†</h3>
    <form id="entryForm">
      <div class="grid-2">
        <div>
          <label>æ—¥æœŸğŸ“…</label>
          <input type="date" id="dateInput" required />
        </div>
        <div>
          <label>é‡‘é¡ğŸ’°</label>
          <input type="number" id="costInput" step="0.01" inputmode="decimal" required />
        </div>
        <div style="grid-column:1 / -1">
          <label>é …ç›®ğŸ¥</label>
          <input type="text" id="itemInput" required />
        </div>
        <div>
          <label>ä»˜éŒ¢çš„äºº ğŸ‘›</label>
          <select id="payerSelect" required>
            <option value="">è«‹é¸æ“‡</option>
            <option value="ä¸ä¸">ä¸ä¸</option>
            <option value="è¿ªè¥¿">è¿ªè¥¿</option>
            <option value="å°æ³¢">å°æ³¢</option>
          </select>
        </div>
        <div>
          <label>æ¬ éŒ¢çš„äºº ğŸ’¸</label>
          <select id="debtorSelect" required>
            <option value="">è«‹å…ˆé¸æ“‡ä»˜éŒ¢çš„äºº</option>
          </select>
        </div>
        <div>
          <label>åˆ†å¸³é¡å‹ âš–ï¸</label>
          <select id="splitSelect" required disabled>
            <!-- å…©å€‹éƒ½æ™‚æœƒéš±è—ã€Œä¸ç”¨åˆ†ã€ï¼Œåªä¿ç•™ å‡åˆ† / ä¸è¦å‡åˆ† -->
            <option value="ä¸ç”¨åˆ†">ä¸ç”¨åˆ†</option>
            <option value="å‡åˆ†">å‡åˆ†</option>
            <option value="ä¸è¦å‡åˆ†">ä¸è¦å‡åˆ†</option>
          </select>
        </div>
      </div>

      <!-- å…©å€‹éƒ½çš„ç´°åˆ†é‡‘é¡ -->
      <div id="splitAmounts" class="hidden" style="margin-top:10px;">
        <div class="grid-2">
          <div>
            <label id="person1Label"></label>
            <input type="number" id="person1Amount" step="0.01" />
          </div>
          <div>
            <label id="person2Label"></label>
            <input type="number" id="person2Amount" step="0.01" />
          </div>
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:10px;">
        <button type="submit" class="primary">â• æ–°å¢</button>
        <span id="msg" style="align-self:center;color:#666"></span>
      </div>
    </form>
  </div>

  <!-- ç´€éŒ„ï¼šç¨ç«‹å¡ç‰‡ï¼ˆåœ¨æ–°å¢ä¸€ç­†ä¸‹æ–¹ï¼‰ -->
  <div class="card">
    <h3 style="margin:0 0 8px 0">ç´€éŒ„</h3>
    <div style="margin-bottom:10px;">
        <button id="refreshBtn" class="pill">ğŸ”„ é‡æ–°æ•´ç†</button>
    </div>
    <table id="dataTable">

      <thead>
        <tr>
          <th>æ—¥æœŸğŸ“…</th><th>é …ç›®ğŸ¥</th><th>ä»˜éŒ¢äººğŸ‘›</th>
          <th>æ¬ éŒ¢äººğŸ’¸</th><th>åˆ†å¸³âš–ï¸</th><th class="right">é‡‘é¡ğŸ’°</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* ====== è¨­å®šï¼ˆå¦³çš„è¡¨å–®/è³‡æ–™ä¾†æºï¼‰ ====== */
const GOOGLE_FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSceaEqQyCGpYWSkHvhT-Im_meidu-xNnuGWLV01HliuFbPgDA/formResponse";
const BASE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR8vvbnkAJU-YpLTquAfQL5K102rAKQc7F_wRQmkQ1slJ2qSnpL3tJycnQ19OdMimVGwatN2USIL0nP/pub?output=csv";

/* è¡¨å–®æ¬„ä½å°ç…§ï¼ˆä¾å¦³æä¾›çš„ entry.*ï¼‰ */
const FORM_FIELDS = {
  splitType: 'entry.528419311',           // åˆ†å¸³é¡å‹
  item: 'entry.2054976462',               // é …ç›®
  cost: 'entry.1660109991',               // é‡‘é¡
  payer: 'entry.235188570',               // ä»˜éŒ¢çš„äºº
  debtor: 'entry.426638451',              // æ¬ éŒ¢çš„äºº
  dateYear: 'entry.1195304321_year',      // æ—¥æœŸ-å¹´ï¼ˆGoogle Form æ—¥æœŸå…ƒä»¶çš„3æ ¼ï¼‰
  dateMonth:'entry.1195304321_month',
  dateDay:  'entry.1195304321_day'
};

const members = ["ä¸ä¸","è¿ªè¥¿","å°æ³¢"];
const $ = s => document.querySelector(s);

/* ====== ä¸Šæ–¹é‡‘é¡åƒ…åšã€Œè®€å–ã€ï¼šç¬¬4åˆ—é–‹å§‹ï¼ŒH=7, I=8, J=9 ====== */
async function updateTop(){
  try{
    const res = await fetch(BASE_CSV_URL + "&cb=" + Date.now());
    const text = await res.text();
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));
    const user = $("#userSelect").value;
    const data = rows.slice(1); // å¾ç¬¬4åˆ—é–‹å§‹
    const found = data.find(r => r[7] === user);
    if(found){
      $("#overallValue").textContent = '$' + (found[8] || '0.00');
      const st = found[9] || 'â€”';
      $("#statusValue").textContent = st;
      const pill = $("#statusValue");
      pill.classList.remove('ok','warn');
      if(/æ¬ /.test(st)) pill.classList.add('warn');
      else if(/é ˜/.test(st)) pill.classList.add('ok');
    }else{
      $("#overallValue").textContent = '$0.00';
      $("#statusValue").textContent = 'â€”';
    }
  }catch(e){ console.error("Top summary read error:", e); }
}
$("#userSelect").addEventListener("change", updateTop);

/* ====== æ¬ éŒ¢é¸å–®é€£å‹• + åˆ†å¸³é¡å‹æ§åˆ¶ ====== */
$("#payerSelect").addEventListener("change", ()=>{
  const payer = $("#payerSelect").value;
  const debtor = $("#debtorSelect");
  debtor.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
  $("#splitSelect").value = "ä¸ç”¨åˆ†";
  $("#splitSelect").disabled = true;
  $("#splitAmounts").classList.add("hidden");

  if(payer){
    members.filter(n=>n!==payer).forEach(n=>{
      const opt=document.createElement("option");
      opt.value=n; opt.textContent=n;
      debtor.appendChild(opt);
    });
    const both=document.createElement("option");
    both.value="å…©å€‹éƒ½"; both.textContent="å…©å€‹éƒ½";
    debtor.appendChild(both);
  }
});

$("#debtorSelect").addEventListener("change", ()=>{
  const val = $("#debtorSelect").value;
  const payer = $("#payerSelect").value;
  const cost = parseFloat($("#costInput").value||0);

  if(val === "å…©å€‹éƒ½"){
    // å…©å€‹éƒ½ â†’ åˆ†å¸³é¡å‹åªç•™ã€Œå‡åˆ†/ä¸è¦å‡åˆ†ã€
    $("#splitSelect").disabled = false;
    // é è¨­é¡¯ç¤ºå‡åˆ†
    $("#splitSelect").value = "å‡åˆ†";
    // é¡¯ç¤ºå…©é‡‘é¡æ¬„
    $("#splitAmounts").classList.remove("hidden");

    // å…©ä½å—æ¬¾äººæ¨™ç±¤
    const others = members.filter(x => x !== payer);
    $("#person1Label").textContent = others[0] + "ï¼š";
    $("#person2Label").textContent = others[1] + "ï¼š";

    // å‡åˆ†ï¼šè‡ªå‹•ç®—ä¸¦é–å®š
    const half = (cost/2).toFixed(2);
    $("#person1Amount").value = half;
    $("#person2Amount").value = half;
    $("#person1Amount").readOnly = true;
    $("#person2Amount").readOnly = true;

    // æŠŠã€Œä¸ç”¨åˆ†ã€é¸é …éš±è—
    [...$("#splitSelect").options].forEach(opt=>{
      if(opt.value==="ä¸ç”¨åˆ†") opt.hidden = true;
    });

  }else{
    // å–®ä¸€æ¬ æ¬¾äºº â†’ ã€Œä¸ç”¨åˆ†ã€å¼·åˆ¶ã€éš±è—å…©é‡‘é¡æ¬„
    $("#splitSelect").disabled = true;
    $("#splitSelect").value = "ä¸ç”¨åˆ†";
    $("#splitAmounts").classList.add("hidden");
    // é¡¯ç¤ºå›ã€Œä¸ç”¨åˆ†ã€é¸é …ï¼ˆé¿å…ä¸‹ä¸€æ¬¡å…©å€‹éƒ½æ™‚ç„¡æ³•åˆ‡æ›ï¼‰
    [...$("#splitSelect").options].forEach(opt=>{
      if(opt.value==="ä¸ç”¨åˆ†") opt.hidden = false;
    });
  }
});

/* é‡‘é¡è®Šå‹•ï¼šè‹¥æ˜¯å‡åˆ† & å…©å€‹éƒ½ â†’ é‡æ–°è¨ˆç®—ä¸¦ç¶­æŒé–å®š */
$("#costInput").addEventListener("input", ()=>{
  if($("#debtorSelect").value === "å…©å€‹éƒ½" && $("#splitSelect").value === "å‡åˆ†"){
    const half = (parseFloat($("#costInput").value||0)/2).toFixed(2);
    $("#person1Amount").value = half;
    $("#person2Amount").value = half;
  }
});

/* åˆ‡æ›åˆ†å¸³é¡å‹ï¼šå‡åˆ†â†’é–å®šï¼›ä¸è¦å‡åˆ†â†’è§£é– */
$("#splitSelect").addEventListener("change", ()=>{
  if($("#debtorSelect").value !== "å…©å€‹éƒ½") return; // å–®äººæ™‚ä¸è™•ç†
  const type = $("#splitSelect").value;
  if(type === "å‡åˆ†"){
    const half = (parseFloat($("#costInput").value||0)/2).toFixed(2);
    $("#person1Amount").value = half;
    $("#person2Amount").value = half;
    $("#person1Amount").readOnly = true;
    $("#person2Amount").readOnly = true;
  }else if(type === "ä¸è¦å‡åˆ†"){
    $("#person1Amount").readOnly = false;
    $("#person2Amount").readOnly = false;
  }
});

/* ====== è¡¨å–®é€å‡ºï¼šå«é˜²å‘† & å…©ç­†æ‹†å–® ====== */
$("#entryForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const msg = $("#msg"); msg.textContent = "é€å‡ºä¸­â€¦";

  const dateStr = $("#dateInput").value;
  if(!dateStr){ msg.textContent = "è«‹é¸æ—¥æœŸ"; return; }
  const d = new Date(dateStr);

  const itemBase = $("#itemInput").value.trim();
  const cost = parseFloat($("#costInput").value);
  const payer = $("#payerSelect").value;
  const debtor = $("#debtorSelect").value;
  let splitType = $("#splitSelect").value;

  if(!payer || !debtor){ msg.textContent="è«‹é¸æ“‡ä»˜éŒ¢äººèˆ‡æ¬ éŒ¢äºº"; return; }
  if(Number.isNaN(cost) || cost <= 0){ msg.textContent="è«‹è¼¸å…¥æ­£ç¢ºçš„é‡‘é¡"; return; }

  // å…©å€‹éƒ½ â†’ é˜²å‘†ï¼šä¸å¾—æœ‰ã€Œä¸ç”¨åˆ†ã€ï¼Œä¸”ä¸è¦å‡åˆ†æ™‚å…©é‡‘é¡ç›¸åŠ å¿…é ˆç­‰æ–¼ç¸½é‡‘é¡
  const isBoth = debtor === "å…©å€‹éƒ½";
  const others = isBoth ? members.filter(x => x !== payer) : [];

  if(isBoth){
    if(splitType === "ä¸ç”¨åˆ†"){
      alert("å…©å€‹éƒ½çš„æƒ…æ³ä¸‹ï¼Œåˆ†å¸³é¡å‹ä¸èƒ½é¸ã€Œä¸ç”¨åˆ†ã€ã€‚");
      msg.textContent="è«‹èª¿æ•´åˆ†å¸³é¡å‹"; return;
    }
    if(splitType === "ä¸è¦å‡åˆ†"){
      const a = parseFloat($("#person1Amount").value||0);
      const b = parseFloat($("#person2Amount").value||0);
      const sum = (a + b);
      const diff = Math.abs(sum - cost);
      if(diff > 0.009){ // å®¹å¿ 1 åˆ†éŒ¢å…§çš„èª¤å·®
        alert(`å…©å€‹é‡‘é¡ç›¸åŠ å¿…é ˆç­‰æ–¼ç¸½é‡‘é¡ã€‚\nç›®å‰ç›¸åŠ ï¼š${sum.toFixed(2)}ï¼Œç¸½é‡‘é¡ï¼š${cost.toFixed(2)}`);
        msg.textContent="é‡‘é¡ä¸ç›¸ç­‰ï¼Œè«‹ä¿®æ­£"; return;
      }
    }
  }

  // å…±ç”¨ï¼šå»ºç«‹åŸºç¤ FormData
  const mkFD = () =>{
    const fd = new FormData();
    fd.append(FORM_FIELDS.dateYear,  d.getFullYear());
    fd.append(FORM_FIELDS.dateMonth, d.getMonth()+1);
    fd.append(FORM_FIELDS.dateDay,   d.getDate());
    return fd;
  };

  const posts = [];
  try{
    if(isBoth){
      // å…©å€‹éƒ½ â†’ é€å…©ç­†ï¼Œä¸¦åœ¨ item å¾Œé¢åŠ ä¸Š (SPLIT)
      const item = itemBase + " (SPLIT)";
      if(splitType === "å‡åˆ†"){
        const half = (cost/2);
        others.forEach(name=>{
          const fd = mkFD();
          fd.append(FORM_FIELDS.item, item);
          fd.append(FORM_FIELDS.cost, half);
          fd.append(FORM_FIELDS.payer, payer);
          fd.append(FORM_FIELDS.debtor, name);
          fd.append(FORM_FIELDS.splitType, "å‡åˆ†");
          posts.push(fetch(GOOGLE_FORM_ACTION,{method:"POST",mode:"no-cors",body:fd}));
        });
      }else{ // ä¸è¦å‡åˆ†
        const a = parseFloat($("#person1Amount").value||0);
        const b = parseFloat($("#person2Amount").value||0);
        [a,b].forEach((amt,i)=>{
          const fd = mkFD();
          fd.append(FORM_FIELDS.item, item);
          fd.append(FORM_FIELDS.cost, amt);
          fd.append(FORM_FIELDS.payer, payer);
          fd.append(FORM_FIELDS.debtor, others[i]);
          fd.append(FORM_FIELDS.splitType, "ä¸è¦å‡åˆ†");
          posts.push(fetch(GOOGLE_FORM_ACTION,{method:"POST",mode:"no-cors",body:fd}));
        });
      }
    }else{
      // å–®ä¸€æ¬ æ¬¾äºº
      const fd = mkFD();
      fd.append(FORM_FIELDS.item, itemBase);
      fd.append(FORM_FIELDS.cost, cost);
      fd.append(FORM_FIELDS.payer, payer);
      fd.append(FORM_FIELDS.debtor, debtor);
      fd.append(FORM_FIELDS.splitType, "ä¸ç”¨åˆ†");
      posts.push(fetch(GOOGLE_FORM_ACTION,{method:"POST",mode:"no-cors",body:fd}));
    }

    await Promise.all(posts);
    msg.textContent = "âœ… å·²æ–°å¢ï¼";
    $("#entryForm").reset();
    $("#splitAmounts").classList.add("hidden");
    setTimeout(()=>msg.textContent="",1800);
    await refresh(); // é€å‡ºå¾Œç«‹å³åˆ·æ–°ï¼ˆå«ä¸Šæ–¹é‡‘é¡ï¼‰
  }catch(err){
    console.error(err);
    msg.textContent = "âŒ é€å‡ºå¤±æ•—";
  }
});

/* ====== ç´€éŒ„è¼‰å…¥ï¼ˆç¬¬4åˆ—èµ·ï¼Œæœ€æ–°åœ¨ä¸Šï¼‰ ====== */
async function refresh(){
  try{
    const res = await fetch(BASE_CSV_URL + "&cb=" + Date.now());
    const text = await res.text();
    const rows = text.trim().split(/\r?\n/).map(r=>r.split(','));
    const data = rows.slice(3).reverse();
    const tbody = $("#dataTable tbody");
    tbody.innerHTML = "";
    data.forEach(r=>{
      const tr=document.createElement("tr");
      // 0:Timestamp,1:Date,2:Item,3:Cost,4:Payer,5:Debtor,6:SplitType,7:HUMAN,8:OVERALL,9:STATUS ...
      tr.innerHTML = `
        <td>${r[1]||''}</td>
        <td>${r[2]||''}</td>
        <td>${r[4]||''}</td>
        <td>${r[5]||''}</td>
        <td>${r[6]||''}</td>
        <td class="right">${r[3]||''}</td>
      `;
      tbody.appendChild(tr);
    });
    await updateTop();
  }catch(e){
    console.error("refresh error:", e);
  }
}
$("#refreshBtn").addEventListener("click", refresh);

/* åˆå§‹ï¼šé¸å–®é è¨­ä¸ä¸ â†’ è¼‰å…¥é‡‘é¡èˆ‡ç´€éŒ„ */
document.addEventListener("DOMContentLoaded", async ()=>{
  // é è¨­æŠŠæ—¥æœŸå¡«ä»Šå¤©ï¼ˆå°åŠ åˆ†ï¼‰
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  $("#dateInput").value = `${yyyy}-${mm}-${dd}`;

  await refresh();
});
</script>
</body>
</html>
