<!DOCTYPE HTML>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>æ¬ éŒ¢ä»” æ¬ éŒ¢ä¸é‚„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    /* light-only, minimal overrides that blend with Strata */
    :root{ --radius:12px; --gap:14px; }
    html,body{ -webkit-text-size-adjust: 100%; }
    .wrap{max-width:980px;margin:0 auto;padding:18px;}
    .card{background:#fff;border:1px solid #eaeaea;border-radius:var(--radius);padding:14px;box-shadow:0 2px 16px rgba(0,0,0,.04);}
    .section{display:grid;grid-template-columns:1.2fr .8fr;gap:var(--gap);}
    .toolbar{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.9);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid #eee;}
    .toolbar .inner2{max-width:980px;margin:0 auto;display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 18px;flex-wrap:wrap;}
    /* --- badge row --- */
    .badge-group{display:flex;align-items:center;gap:12px 14px;flex-wrap:wrap;}
    .badge{display:flex;align-items:center;gap:6px;white-space:nowrap;}
    /* long rectangular bar */
    .pill{
      display:inline-flex;align-items:center;height:40px;
      padding:0 16px;border-radius:10px;border:1px solid #e6e6e6;
      background:#f7f7f7;font-weight:600;line-height:1;white-space:nowrap;
      width:max-content;max-width:none;
    }
    .pill.ok{background:#e9f7ef;border-color:#d4efdf}
    .pill.warn{background:#fff6e6;border-color:#ffe0a3}
    form label{display:block;margin:.5rem 0 .25rem}
    input,select,button{width:100%;padding:14px;border:1px solid #ddd;border-radius:10px;font-size:16px;background:#fff}
    button{cursor:pointer;background:#f5f5f5}
    button.primary{background:#111;color:#fff;border-color:#111}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    .muted{color:#666}
    .table-wrap{margin-top:12px}

    /* Base table (desktop/tablet) */
    table.responsive{min-width:560px;width:100%;border-collapse:collapse}
    th,td{padding:.65rem;border-bottom:1px solid #eee;text-align:left}
    td.right,th.right{text-align:right}
    tfoot td{font-weight:700}

    /* iPhone/mobile layout */
    @media (max-width: 880px){
      .section{grid-template-columns:1fr}
      .grid-2{grid-template-columns:1fr}
      .toolbar .inner2{gap:8px;align-items:flex-start}
      .badge-group{width:100%;justify-content:space-between}
      .wrap{padding:14px}
    }
    @media (max-width: 540px){
      /* turn table into stacked cards */
      table.responsive{border-collapse:separate;border-spacing:0 12px;min-width:0}
      table.responsive thead{display:none}
      table.responsive tr{
        display:block;background:#fff;border:1px solid #eee;border-radius:12px;
        box-shadow:0 1px 6px rgba(0,0,0,.06);overflow:hidden;
      }
      table.responsive td{
        display:flex;justify-content:space-between;gap:12px;
        padding:12px 14px;border-bottom:1px solid #f4f4f4;
      }
      table.responsive td:last-child{border-bottom:none}
      table.responsive td::before{
        content: attr(data-label);
        font-weight:600;color:#444;
      }
      td.right{text-align:left}
      /* inputs & buttons full-width and comfy tap targets */
      .grid-2{gap:10px}
      input,select,button{padding:16px;border-radius:12px}
      .pill{height:40px}
    }

    .table-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:8px;
  }
  @media (max-width:540px){
    .table-header{flex-wrap:wrap}
    .table-header h3{margin:0}
    .table-header #refreshBtn{width:100%} /* full-width on iPhone for easy tap */
  }

  </style>
</head>
<body class="is-preload">
  <!-- Header -->
  <header id="header">
    <div class="inner">
      <h1><strong>CHIAYU's WEBSITE</strong></h1>
      <h1>An Engineer.</h1>
    </div>
  </header>

  <!-- sticky toolbar with badges -->
  <div class="toolbar">
    <div class="inner2">
      <div><b>æ¬ éŒ¢ä»” æ¬ éŒ¢ä¸é‚„</b></div>
      <div class="badge-group">
        <div class="badge">ç¸½é‡‘é¡ <span id="overallValue" class="pill warn">â€”</span></div>
        <div class="badge">ä»€éº¼ä»”  <span id="statusValue"  class="pill warn">Loadingâ€¦</span></div>
      </div>
    </div>
  </div>

  <div id="main" class="wrap">
    <section id="one">
      <header class="major">
        <h2>æ¬ éŒ¢ä»” æ¬ éŒ¢ä¸é‚„</h2>
        <p class="muted">è¼¸å…¥æ—¥æœŸã€é …ç›®ã€é‡‘é¡</p>
      </header>

      <div class="section">
        <!-- left: input -->
        <div class="card" style="margin-top:var(--gap)">
        <div class="table-header">
          <h3 style="margin:0">æ‰€æœ‰é …ç›®</h3>
          <button id="refreshBtn" class="pill" type="button">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div>
        <div class="table-wrap">
          <table id="dataTable" class="responsive" role="table">
            <thead>
              <tr><th>æ—¥æœŸğŸ“…</th><th>é …ç›®ğŸ¥</th><th class="right">é‡‘é¡ğŸ’°</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

            <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
              <button type="submit" class="primary" style="flex:1 1 180px">â• æ–°å¢</button>
              <span id="msg" class="muted" aria-live="polite" style="align-self:center"></span>
            </div>
          </form>
          <p class="muted" style="margin:.6rem 0 0">é€å‡ºå¾Œ 1â€“2 ç§’è‡ªå‹•æ›´æ–°ï¼›è‹¥æœªçœ‹åˆ°æ–°è³‡æ–™è«‹æŒ‰ã€Œé‡æ–°æ•´ç†ã€ã€‚</p>
        </div>

        <!-- (optional right column removed on mobile automatically) -->
      </div>

      <!-- table -->
      <div class="card" style="margin-top:var(--gap)">
        <h3 style="margin-top:0">æ‰€æœ‰é …ç›®</h3>
        <div class="table-wrap">
          <table id="dataTable" class="responsive" role="table">
            <thead>
              <tr><th>æ—¥æœŸğŸ“…</th><th>é …ç›®ğŸ¥</th><th class="right">é‡‘é¡ğŸ’°</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

<script>
/* ====== your Google Form / Sheet config ====== */
const GOOGLE_FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSd4fYEjOVAd4pqplNQPAVHjmNAfgHSuKATlyZjpPlLcxYlPEw/formResponse";
const FORM_FIELDS = {
  dateYear:  'entry.1832617978_year',
  dateMonth: 'entry.1832617978_month',
  dateDay:   'entry.1832617978_day',
  item:      'entry.1202275953',
  cost:      'entry.1361977711' // you confirmed this is correct
};
// your published CSV (Form_Responses2 tab)
const BASE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqlW9LOjG7ElOjhal3gZ1v3EKiXMiml-NFSsWH_fD3efz0-G4QYNJcT2woUl1iB5f5DUGMYrzbEYOd/pub?gid=1232924297&single=true&output=csv";

/* ==== helpers ==== */
const $ = s => document.querySelector(s);
const fmtMoney = n => isNaN(n) ? '$0.00' : (n < 0 ? '-' : '') + '$' + Math.abs(n).toFixed(2);
const csvUrl = () => BASE_CSV_URL + (BASE_CSV_URL.includes('?') ? '&' : '?') + 'cb=' + Date.now();
const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };


/* ==== CSV fetch & parse ==== */
async function fetchCSV(){ const res = await fetch(csvUrl(), { cache: 'no-store' }); return await res.text(); }
function detectDelimiter(text){ const first=text.split(/\r?\n/)[0]||''; const c=(first.match(/,/g)||[]).length, s=(first.match(/;/g)||[]).length; return s>c?';':','; }
function parseCSV(text){
  const d = detectDelimiter(text);
  if (d === ';') return text.trim().split(/\r?\n/).map(l=>l.split(';').map(s=>s.replace(/^"(.*)"$/,'$1')));
  const rows=[]; let row=[], cur='', q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c==='"'&&q&&n==='"'){cur+='"';i++;continue;}
    if(c==='"'){q=!q;continue;}
    if(c===','&&!q){row.push(cur);cur='';continue;}
    if((c==='\n'||c==='\r')&&!q){if(cur.length||row.length){row.push(cur);rows.push(row);}row=[];cur='';continue;}
    cur+=c;
  }
  if(cur.length||row.length){row.push(cur);rows.push(row);}
  return rows;
}

/* ==== UI rendering (last row first) ==== */
function renderTable(rows){
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  let sumVisible = 0;

  const dataRows = rows.slice(1).filter(r =>
    r && r.some(c => String(c || '').trim() !== '')
  );

  // newest first
  dataRows.reverse().forEach(r => {
    const date = r[1] || r[0];               // B: Date (fallback A)
    const item = r[2] || '';                 // C: Item
    const cost = parseFloat((r[3] || '').replace(/[^0-9.\-]/g, '')); // D: Cost
    if (!date && !item && isNaN(cost)) return;

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td data-label="æ—¥æœŸğŸ“…">${date || ''}</td>
      <td data-label="é …ç›®ğŸ¥">${item || ''}</td>
      <td data-label="é‡‘é¡ğŸ’°" class="right">${isNaN(cost)?'':fmtMoney(cost)}</td>
    `;
    tbody.appendChild(tr);
    if(!isNaN(cost)) sumVisible += cost;
  });

  // optional totals (won't error if the elements don't exist)
  setText('visibleSum', fmtMoney(sumVisible));
  setText('total',      fmtMoney(sumVisible));
  setText('totalAll',   fmtMoney(sumVisible));
}

function updateTopBadges(rows){
  if(!rows || !rows.length){ setText('overallValue','â€”'); setText('statusValue','â€”'); return; }
  const headers = rows[0].map(h => (h||'').toString().trim());
  const norm = s => (s||'').toString().trim().toUpperCase();
  let overallIdx = headers.findIndex(h => norm(h).includes('OVERALL'));
  let statusIdx  = headers.findIndex(h => norm(h).includes('STATUS'));
  if (overallIdx < 0) overallIdx = 4; // E
  if (statusIdx  < 0) statusIdx  = 5; // F
  const pick = (col) => {
    if (rows[1] && rows[1][col] !== undefined && rows[1][col] !== '') return rows[1][col];
    for(let r=1;r<rows.length;r++){ if(rows[r] && String(rows[r][col]||'').trim()!=='') return rows[r][col]; }
    return 'â€”';
  };
  const overall = pick(overallIdx), status = pick(statusIdx);
  setText('overallValue', overall);
  setText('statusValue', status);

  const ovEl = $('#overallValue'), stEl = $('#statusValue');
  if (ovEl && stEl){
    stEl.classList.remove('ok','warn'); ovEl.classList.remove('ok','warn');
    const isUnpaid = /UNPAID|æœª|æ¬ /i.test(String(status)) || (/^\s*[1-9]\d*(\.\d+)?\s*$/.test(String(overall)));
    if (isUnpaid){ stEl.classList.add('warn'); ovEl.classList.add('warn'); }
    else { stEl.classList.add('ok'); ovEl.classList.add('ok'); }
  }
}

/* ==== refresh flow ==== */
async function refresh(){
  try{
    setText('statusValue','Loadingâ€¦');
    const csvText = await fetchCSV();
    const rows = parseCSV(csvText);
    renderTable(rows);
    updateTopBadges(rows);
  }catch(e){
    console.error(e);
    setText('statusValue','Load error');
  }
}
$('#refreshBtn').addEventListener('click', refresh);

/* ==== submit to Google Form ==== */
$('#entryForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const msg = $('#msg'); if (msg) msg.textContent = 'é€å‡ºä¸­â€¦';
  const dVal = $('#dateInput').value; if(!dVal){ if (msg) msg.textContent='è«‹é¸æ—¥æœŸ'; return; }
  const d = new Date(dVal);
  const fd = new FormData();
  fd.append(FORM_FIELDS.dateYear,  d.getFullYear());
  fd.append(FORM_FIELDS.dateMonth, d.getMonth()+1);
  fd.append(FORM_FIELDS.dateDay,   d.getDate());
  fd.append(FORM_FIELDS.item, $('#itemInput').value.trim());
  fd.append(FORM_FIELDS.cost, $('#costInput').value.trim());
  try{
    await fetch(GOOGLE_FORM_ACTION,{method:'POST',mode:'no-cors',body:fd});
    if (msg) msg.textContent='å·²æ–°å¢ï¼';
    $('#itemInput').value=''; $('#costInput').value='';
    setTimeout(refresh,900); setTimeout(refresh,2200);
    setTimeout(()=>{ if (msg) msg.textContent=''; },2000);
  }catch(err){
    console.error(err);
    if (msg) msg.textContent='é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦';
  }
});

// initial load
refresh();
</script>
</body>
</html>
