<!DOCTYPE HTML>
<html>
<head>
  <title>Shared Cost Tracker</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; }
    tfoot td { font-weight: bold; }
    .right { text-align: right; }
    button { cursor: pointer; }
  </style>
</head>
<body class="is-preload">
<header id="header">
  <div class="inner">
    <h1><strong>CHIAYU's WEBSITE</strong></h1>
    <h1>An Engineer.</h1>
    <h1 align="right"><a href="https://chiayuu.github.io/"> HOME â– </a></h1>
    <h1 align="right"><a href="scloutline.html"> SCHOOL PROJECT â– </a></h1>
    <h1 align="right"><a href="selfoutline.html"> SELF PROJECT â– </a></h1>
    <h1 align="right"><b>SECRET PAGE â– </b></h1>
  </div>
</header>

<div id="main">
  <section id="one">
    <header class="major">
      <h2>ğŸ’¸ Shared Cost Tracker</h2>
      <p>è¼¸å…¥æ—¥æœŸã€é …ç›®ã€é‡‘é¡ï¼Œå¯«é€² Google Sheets ä¸¦å³æ™‚æ›´æ–°ä¸‹æ–¹è¡¨æ ¼ã€‚</p>
    </header>

    <!-- è¡¨å–® -->
    <form id="entryForm">
      <label>æ—¥æœŸï¼š<input type="date" id="dateInput" required></label><br>
      <label>é …ç›®ï¼š<input type="text" id="itemInput" required></label><br>
      <label>é‡‘é¡ï¼š<input type="number" id="costInput" step="0.01" required></label><br>
      <button type="submit">â• æ–°å¢</button>
      <span id="msg" style="margin-left:.5rem;color:gray;"></span>
    </form>

    <!-- é¡¯ç¤ºè¡¨æ ¼ -->
    <table id="dataTable">
      <thead>
        <tr><th>æ—¥æœŸ</th><th>é …ç›®</th><th class="right">é‡‘é¡</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="2" class="right">åˆè¨ˆï¼š</td><td class="right" id="total">$0.00</td></tr>
      </tfoot>
    </table>
    <button id="refreshBtn" style="margin-top:.5rem;">ğŸ”„ é‡æ–°æ•´ç†</button>
  </section>
</div>

<script>
/* ========== é€™è£¡æ”¾ä½ çš„ Google Form è¨­å®š ========== */
const GOOGLE_FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSd4fYEjOVAd4pqplNQPAVHjmNAfgHSuKATlyZjpPlLcxYlPEw/formResponse";

const FORM_FIELDS = {
  dateYear:  'entry.1832617978_year',
  dateMonth: 'entry.1832617978_month',
  dateDay:   'entry.1832617978_day',
  item:      'entry.1202275953',
  cost:      'entry.1361977771'
  // status: 'entry.xxxxxxxx' // å¦‚æœä¹‹å¾ŒåŠ äº†ç‹€æ…‹ï¼Œè£œé€™è£¡
};

// ç™¼ä½ˆç‚º CSV çš„ç¶²å€ï¼Œè¨˜å¾—åœ¨ Google Sheet -> æª”æ¡ˆ -> åˆ†äº« -> ç™¼ä½ˆåˆ°ç¶²è·¯ï¼Œè¤‡è£½ CSV é€£çµ
const PUBLISHED_CSV_URL = "https://docs.google.com/spreadsheets/d/e/.../pub?output=csv";
/* ================================================= */

function formatMoney(n) {
  return isNaN(n) ? '$0.00' : '$' + n.toFixed(2);
}

async function fetchCSV() {
  const res = await fetch(PUBLISHED_CSV_URL, { cache: 'no-store' });
  const text = await res.text();
  const rows = text.trim().split('\n').map(r => r.split(','));
  return rows;
}

async function refreshTable() {
  try {
    const rows = await fetchCSV();
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    let sum = 0;
    rows.slice(1).forEach(r => {
      const date = r[0], item = r[1], cost = parseFloat(r[2]);
      if (!date && !item && isNaN(cost)) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${date}</td><td>${item}</td><td class="right">${formatMoney(cost)}</td>`;
      tbody.appendChild(tr);
      if (!isNaN(cost)) sum += cost;
    });
    document.getElementById('total').textContent = formatMoney(sum);
  } catch (e) {
    console.error('è®€å–è¡¨æ ¼å¤±æ•—', e);
  }
}

document.getElementById('refreshBtn').addEventListener('click', refreshTable);

document.getElementById('entryForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const msg = document.getElementById('msg');
  msg.textContent = 'é€å‡ºä¸­...';

  const d = new Date(document.getElementById('dateInput').value);
  const fd = new FormData();
  fd.append(FORM_FIELDS.dateYear,  d.getFullYear());
  fd.append(FORM_FIELDS.dateMonth, d.getMonth() + 1);
  fd.append(FORM_FIELDS.dateDay,   d.getDate());
  fd.append(FORM_FIELDS.item, document.getElementById('itemInput').value.trim());
  fd.append(FORM_FIELDS.cost, document.getElementById('costInput').value.trim());

  try {
    await fetch(GOOGLE_FORM_ACTION, { method: 'POST', mode: 'no-cors', body: fd });
    msg.textContent = 'å·²æ–°å¢ï¼';
    document.getElementById('itemInput').value = '';
    document.getElementById('costInput').value = '';
    setTimeout(refreshTable, 1200); // ç¨ç­‰ Google å¯«å…¥
    setTimeout(() => msg.textContent = '', 2000);
  } catch (err) {
    console.error(err);
    msg.textContent = 'é€å‡ºå¤±æ•—';
  }
});

// åˆå§‹è¼‰å…¥è¡¨æ ¼
refreshTable();
</script>
</body>
</html>
