<!DOCTYPE HTML>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <title>Shared Cost Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    :root{
      --radius:14px; --pad:14px; --gap:14px; --font:16px;
    }
    body{font-size:var(--font); line-height:1.55;}
    .wrap{max-width:980px;margin:0 auto;padding:16px;}
    .card{background:#fff;border:1px solid #eaeaea;border-radius:var(--radius);padding:var(--pad);box-shadow:0 2px 16px rgba(0,0,0,.04);}
    .section{display:grid;grid-template-columns:1.2fr .8fr;gap:var(--gap);}
    .toolbar{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.85);backdrop-filter:saturate(180%) blur(8px);border-bottom:1px solid #eee;padding:10px 16px;}
    .toolbar .inline{display:flex;gap:10px;align-items:center;justify-content:space-between;max-width:980px;margin:0 auto;}
    .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;border:1px solid #e6e6e6;font-weight:600}
    .pill.ok{background:#e9f7ef;border-color:#d4efdf}
    .pill.warn{background:#fff6e6;border-color:#ffe0a3}
    form label{display:block;margin:.5rem 0 .25rem}
    input,select,button{width:100%;padding:.7rem .8rem;border:1px solid #ddd;border-radius:10px;font-size:1rem}
    button{cursor:pointer;border:1px solid #ccc;background:#f7f7f7}
    button.primary{background:#111;color:#fff;border-color:#111}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    .muted{color:#666}
    .table-wrap{overflow-x:auto;margin-top:12px}
    table{min-width:560px;width:100%;border-collapse:collapse}
    th,td{padding:.65rem;border-bottom:1px solid #eee;text-align:left}
    td.right,th.right{text-align:right}
    tfoot td{font-weight:700}
    @media (max-width: 880px){
      :root{--font:17px}
      .section{grid-template-columns:1fr}
      .grid-2{grid-template-columns:1fr}
      .toolbar .inline{gap:8px}
    }
    @media (prefers-color-scheme: dark){
      body{background:#0b0b0b;color:#e7e7e7}
      .card{background:#141414;border-color:#2a2a2a;box-shadow:none}
      input,select{background:#0f0f0f;border-color:#2a2a2a;color:#e7e7e7}
      button{background:#1c1c1c;border-color:#2a2a2a;color:#e7e7e7}
      table{color:#e7e7e7}
      th,td{border-bottom:1px solid #2a2a2a}
      .toolbar{background:rgba(11,11,11,.85);border-color:#2a2a2a}
    }
  </style>
</head>
<body class="is-preload">

  <!-- ç«™é ­ï¼ˆæ²¿ç”¨ä½ çš„æ¨£å¼ï¼‰ -->
  <header id="header">
    <div class="inner">
      <h1><strong>CHIAYU's WEBSITE</strong></h1>
      <h1>An Engineer.</h1>
      <h1 align="right"><a href="https://chiayuu.github.io/"> HOME â– </a></h1>
      <h1 align="right"><a href="scloutline.html"> SCHOOL PROJECT â– </a></h1>
      <h1 align="right"><a href="selfoutline.html"> SELF PROJECT â– </a></h1>
      <h1 align="right"><b>SECRET PAGE â– </b></h1>
    </div>
  </header>

  <!-- å¸é ‚å·¥å…·åˆ—ï¼ˆæ‰‹æ©Ÿæ“ä½œæ›´æ–¹ä¾¿ï¼‰ -->
  <div class="toolbar">
    <div class="inline">
      <div><b>Shared Cost Tracker</b></div>
      <div style="display:flex;gap:8px;align-items:center">
        <span>OVERALL: <span id="overallValue" class="pill warn">â€”</span></span>
        <span>STATUS: <span id="statusValue" class="pill warn">Loadingâ€¦</span></span>
        <button id="refreshBtn" class="pill" type="button">ğŸ”„ Refresh</button>
      </div>
    </div>
  </div>

  <div id="main" class="wrap">
    <section id="one">
      <div class="section">
        <!-- å·¦ï¼šè¼¸å…¥ -->
        <div class="card">
          <h3 style="margin-top:0">æ–°å¢ä¸€ç­†</h3>
          <form id="entryForm">
            <div class="grid-2">
              <div>
                <label>æ—¥æœŸ</label>
                <input type="date" id="dateInput" required />
              </div>
              <div>
                <label>é‡‘é¡</label>
                <input type="number" id="costInput" step="0.01" inputmode="decimal" placeholder="ä¾‹å¦‚ 12.50" required />
              </div>
              <div>
                <label>é …ç›®</label>
                <input type="text" id="itemInput" placeholder="Coffee / Uber ..." required />
              </div>
              <div>
                <label class="muted">ç‹€æ…‹ï¼ˆè¡¨å–®å°šæœªå»ºç«‹å¯ç•¥ï¼‰</label>
                <select id="statusInput" disabled>
                  <option value="">â€”</option>
                </select>
              </div>
            </div>
            <div style="display:flex;gap:10px;margin-top:10px">
              <button type="submit" class="primary">â• æ–°å¢</button>
              <span id="msg" class="muted" aria-live="polite"></span>
            </div>
          </form>
          <p class="muted" style="margin:.6rem 0 0">é€å‡ºå¾Œ 1â€“2 ç§’è‡ªå‹•æ›´æ–°ï¼›è‹¥æœªçœ‹åˆ°æ–°è³‡æ–™è«‹æŒ‰ Refreshã€‚</p>
        </div>

        <!-- å³ï¼šç¸½è¦½ -->
        <div class="card">
          <h3 style="margin-top:0">ç¸½è¦½</h3>
          <div class="grid-2">
            <div><b>åˆè¨ˆï¼ˆé é¢è¨ˆï¼‰</b><br><span id="totalAll">$0.00</span></div>
            <div><b>å¯è¦‹åˆ—åˆè¨ˆ</b><br><span id="visibleSum">$0.00</span></div>
          </div>
          <p class="muted" style="margin-top:10px">
            ä¸Šæ–¹ OVERALL / STATUS ç›´æ¥å–è‡ªè©¦ç®—è¡¨ E/F æ¬„ï¼ˆä½ çš„å…¬å¼è¨ˆç®—çµæœï¼‰ã€‚
          </p>
        </div>
      </div>

      <!-- è¡¨æ ¼ -->
      <div class="card" style="margin-top:var(--gap)">
        <h3 style="margin-top:0">æ‰€æœ‰é …ç›®</h3>
        <div class="table-wrap">
          <table id="dataTable" role="table">
            <thead>
              <tr><th>æ—¥æœŸ</th><th>é …ç›®</th><th class="right">é‡‘é¡</th></tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <td colspan="2" class="right">åˆè¨ˆï¼š</td>
                <td class="right" id="total">$0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>
  </div>

<script>
/* ====== å¿…å¡«ï¼šä½ çš„ Google Form / Sheet é€£çµè¨­å®š ====== */
const GOOGLE_FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSd4fYEjOVAd4pqplNQPAVHjmNAfgHSuKATlyZjpPlLcxYlPEw/formResponse";
const FORM_FIELDS = {
  dateYear:  'entry.1832617978_year',
  dateMonth: 'entry.1832617978_month',
  dateDay:   'entry.1832617978_day',
  item:      'entry.1202275953',
  cost:      'entry.1361977771'
  // è‹¥ä¹‹å¾Œåœ¨ Google è¡¨å–®æ–°å¢ç‹€æ…‹æ¬„ä½ï¼š status: 'entry.xxxxxxxxxx'
};
// â¬‡ï¸ æŠŠä¸‹é¢æ›æˆä½ çš„ã€Œç™¼ä½ˆåˆ°ç¶²è·¯ â†’ CSVã€é€£çµ
const PUBLISHED_CSV_URL = "https://docs.google.com/spreadsheets/d/e/REPLACE_ME/pub?output=csv";
/* ===================================================== */

const $ = s => document.querySelector(s);
const fmtMoney = n => isNaN(n) ? '$0.00' : (n < 0 ? '-' : '') + '$' + Math.abs(n).toFixed(2);

async function fetchCSV(url){
  const res = await fetch(url, {cache:'no-store'});
  return await res.text();
}

// ç°¡å–® CSV è§£æï¼ˆæ”¯æ´å¼•è™Ÿèˆ‡é€—è™Ÿï¼‰
function parseCSV(text){
  const rows=[]; let row=[], cur='', q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(c==='"' && q && n==='"'){ cur+='"'; i++; continue; }
    if(c==='"'){ q=!q; continue; }
    if(c===',' && !q){ row.push(cur); cur=''; continue; }
    if((c==='\n'||c==='\r') && !q){ if(cur.length||row.length){ row.push(cur); rows.push(row); } row=[]; cur=''; continue; }
    cur+=c;
  }
  if(cur.length||row.length){ row.push(cur); rows.push(row); }
  return rows;
}

function renderTable(rows){
  const tbody = $('#dataTable tbody');
  tbody.innerHTML = '';
  let sumVisible = 0;
  rows.slice(1).forEach(r=>{
    const date=r[0], item=r[1], cost=parseFloat((r[2]||'').replace(/[^0-9.\-]/g,''));
    if(!date && !item && isNaN(cost)) return;
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${date||''}</td><td>${item||''}</td><td class="right">${isNaN(cost)?'':fmtMoney(cost)}</td>`;
    tbody.appendChild(tr);
    if(!isNaN(cost)) sumVisible += cost;
  });
  $('#visibleSum').textContent = fmtMoney(sumVisible);
  $('#total').textContent = fmtMoney(sumVisible);
  $('#totalAll').textContent = fmtMoney(sumVisible); // ç°¡æ˜“ï¼šé é¢ç¸½è¨ˆåŒ visible
}

function updateTopBadges(rows){
  const headers = rows[0] || [];
  const overallIdx = headers.findIndex(h => (h||'').toUpperCase().includes('OVERALL'));
  const statusIdx  = headers.findIndex(h => (h||'').toUpperCase().includes('STATUS'));
  const row2 = rows[1] || [];
  const overall = overallIdx>=0 ? (row2[overallIdx] || '0') : 'â€”';
  const status  = statusIdx>=0  ? (row2[statusIdx]  || 'â€”') : 'â€”';
  const overallEl = $('#overallValue');
  const statusEl  = $('#statusValue');
  overallEl.textContent = overall;
  statusEl.textContent  = status;

  // æ¨™ç±¤é¡è‰²
  statusEl.classList.remove('ok','warn');
  overallEl.classList.remove('ok','warn');
  const unpaid = String(status).toLowerCase().includes('unpaid') || String(overall).match(/^[1-9]\d*(\.\d+)?$/);
  if (unpaid){ statusEl.classList.add('warn'); overallEl.classList.add('warn'); }
  else { statusEl.classList.add('ok'); overallEl.classList.add('ok'); }
}

async function refresh(){
  try{
    $('#statusValue').textContent = 'Loadingâ€¦';
    const csv = await fetchCSV(PUBLISHED_CSV_URL);
    const rows = parseCSV(csv);
    renderTable(rows);
    updateTopBadges(rows);
  }catch(e){
    console.error(e);
    $('#statusValue').textContent = 'Load error';
  }
}

$('#refreshBtn').addEventListener('click', refresh);

$('#entryForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const msg = $('#msg');
  msg.textContent = 'é€å‡ºä¸­â€¦';

  const dVal = $('#dateInput').value;
  if(!dVal){ msg.textContent='è«‹é¸æ—¥æœŸ'; return; }
  const d = new Date(dVal);

  const fd = new FormData();
  fd.append(FORM_FIELDS.dateYear,  d.getFullYear());
  fd.append(FORM_FIELDS.dateMonth, d.getMonth()+1);
  fd.append(FORM_FIELDS.dateDay,   d.getDate());
  fd.append(FORM_FIELDS.item, $('#itemInput').value.trim());
  fd.append(FORM_FIELDS.cost, $('#costInput').value.trim());

  try{
    await fetch(GOOGLE_FORM_ACTION, { method:'POST', mode:'no-cors', body:fd });
    msg.textContent = 'å·²æ–°å¢ï¼';
    $('#itemInput').value = '';
    $('#costInput').value = '';
    setTimeout(refresh, 900);
    setTimeout(refresh, 2200);
    setTimeout(()=> msg.textContent='', 2000);
  }catch(err){
    console.error(err);
    msg.textContent = 'é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦';
  }
});

// åˆæ¬¡è¼‰å…¥
refresh();
</script>
</body>
</html>
